document.addEventListener("DOMContentLoaded", function() {
    const domainGrid = document.getElementById("domain-grid");
    const domainListBody = document.querySelector(".domain-list-body");
    const searchInput = document.getElementById("search-input");
    const searchButton = document.getElementById("search-button");
    const priceFilter = document.getElementById("price-filter");
    const tldFilter = document.getElementById("tld-filter");
    const sortSelect = document.getElementById("sort-select");
    const gridViewBtn = document.getElementById("grid-view-btn");
    const listViewBtn = document.getElementById("list-view-btn");
    const domainContainer = document.getElementById("domain-container");
    
    let allDomains = [];
    let currentView = 'list';  // Set default view to list

    // View Toggle Handlers
    gridViewBtn.addEventListener('click', () => {
        setView('grid');
    });

    listViewBtn.addEventListener('click', () => {
        setView('list');
    });

    function setView(view) {
        currentView = view;
        domainContainer.className = `${view}-view`;
        gridViewBtn.classList.toggle('active', view === 'grid');
        listViewBtn.classList.toggle('active', view === 'list');
        localStorage.setItem('preferredView', view);
    }

    // Load preferred view
    const savedView = localStorage.getItem('preferredView') || 'list';
    setView(savedView);

    function showLoading(element) {
        element.textContent = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.textContent = 'Loading domains...';
        element.appendChild(loadingDiv);
    }

    showLoading(domainGrid);
    showLoading(domainListBody);

    function generateGradientColors(text) {
        const hue1 = (text.charCodeAt(0) * 7) % 360;
        const hue2 = (hue1 + 40) % 360;
        return {
            from: `hsl(${hue1}, 60%, 45%)`,
            to: `hsl(${hue2}, 65%, 40%)`
        };
    }

    function getCustomPreviewUrl(domainName) {
        const fileName = domainName.toLowerCase().replace('.', '_') + '.jpg';
        return `/data/output/custom_previews/${fileName}`;
    }

    fetch('/data/output/domains.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(domains => {
            allDomains = domains;
            populateTldFilter(domains);
            displayDomains(domains);
            console.log(`Loaded ${domains.length} domains successfully`);
        })
        .catch(error => {
            console.error('Error loading domains:', error);
            function showError(element) {
                element.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                
                const errorText = document.createElement('p');
                errorText.textContent = `Error loading domains: ${error.message}`;
                errorDiv.appendChild(errorText);
                
                const helpText = document.createElement('p');
                helpText.textContent = 'Please try refreshing the page or contact support if the problem persists.';
                errorDiv.appendChild(helpText);
                
                element.appendChild(errorDiv);
            }
            
            showError(domainGrid);
            showError(domainListBody);
        });

    function populateTldFilter(domains) {
        const tlds = [...new Set(domains.map(domain => domain.tld))].sort();
        tldFilter.textContent = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'All';
        tldFilter.appendChild(defaultOption);
        
        tlds.forEach(tld => {
            const option = document.createElement('option');
            option.value = tld;
            option.textContent = `.${tld}`;
            tldFilter.appendChild(option);
        });
    }

    function filterDomains(domains) {
        const searchTerm = searchInput.value.toLowerCase();
        const maxPrice = parseInt(priceFilter.value) || Infinity;
        const selectedTld = tldFilter.value;

        return domains.filter(domain => {
            const matchesSearch = domain.domainName.toLowerCase().includes(searchTerm);
            const matchesPrice = domain.price <= maxPrice;
            const matchesTld = !selectedTld || domain.tld === selectedTld;
            return matchesSearch && matchesPrice && matchesTld;
        });
    }

    function sortDomains(domains) {
        const [criteria, direction] = sortSelect.value.split('-');
        return [...domains].sort((a, b) => {
            let comparison = 0;
            if (criteria === 'name') {
                comparison = a.domainName.toLowerCase().localeCompare(b.domainName.toLowerCase());
            } else if (criteria === 'price') {
                comparison = a.price - b.price;
            }
            return direction === 'desc' ? -comparison : comparison;
        });
    }

    function createGridItem(domain) {
        const div = document.createElement("div");
        div.className = "domain-item";

        const previewContainer = document.createElement("div");
        previewContainer.className = "relative";

        const img = document.createElement("img");
        img.src = getCustomPreviewUrl(domain.domainName);
        img.alt = `${domain.domainName} preview`;
        img.className = "w-full h-48 object-cover rounded-t-lg";
        
        const fallbackDiv = document.createElement("div");
        fallbackDiv.className = "w-full h-48 rounded-t-lg hidden items-center justify-center";
        const colors = generateGradientColors(domain.domainName);
        fallbackDiv.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        
        const domainText = document.createElement("span");
        domainText.className = "text-white text-2xl font-bold";
        domainText.textContent = domain.domainName;
        fallbackDiv.appendChild(domainText);

        img.onerror = () => {
            img.style.display = 'none';
            fallbackDiv.style.display = 'flex';
        };

        previewContainer.appendChild(img);
        previewContainer.appendChild(fallbackDiv);
        div.appendChild(previewContainer);

        const contentDiv = document.createElement("div");
        contentDiv.className = "p-4";

        const h2 = document.createElement("h2");
        h2.className = "text-xl font-semibold text-gray-900 mb-2";
        h2.textContent = domain.domainName;
        contentDiv.appendChild(h2);

        const p = document.createElement("p");
        p.className = "text-lg font-bold text-green-600 mb-4";
        p.textContent = `$${domain.price.toLocaleString()}`;
        contentDiv.appendChild(p);

        const a = document.createElement("a");
        a.href = `domains/${domain.domainName}`;
        a.className = "buy-button w-full text-center";
        a.textContent = "View Details";
        contentDiv.appendChild(a);

        div.appendChild(contentDiv);
        return div;
    }

    function createListItem(domain) {
        const div = document.createElement("div");
        div.className = "domain-list-item";

        const [name, tld] = domain.domainName.split('.');

        const nameDiv = document.createElement("div");
        nameDiv.className = "domain-list-name";
        nameDiv.textContent = name;

        const tldDiv = document.createElement("div");
        tldDiv.className = "domain-list-tld";
        tldDiv.textContent = `.${tld}`;

        const priceDiv = document.createElement("div");
        priceDiv.className = "domain-list-price";
        priceDiv.textContent = `$${domain.price.toLocaleString()}`;

        const actionDiv = document.createElement("div");
        actionDiv.className = "domain-list-action";
        const a = document.createElement("a");
        a.href = `domains/${domain.domainName}`;
        a.className = "buy-button";
        a.textContent = "View Details";
        actionDiv.appendChild(a);

        div.appendChild(nameDiv);
        div.appendChild(tldDiv);
        div.appendChild(priceDiv);
        div.appendChild(actionDiv);

        return div;
    }

    function displayDomains(domains) {
        const sortedDomains = sortDomains(domains);
        
        if (sortedDomains.length === 0) {
            const createNoResults = (element) => {
                element.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'No domains found matching your criteria.';
                element.appendChild(errorDiv);
            };
            
            createNoResults(domainGrid);
            createNoResults(domainListBody);
            return;
        }
        
        domainGrid.textContent = '';
        sortedDomains.forEach(domain => {
            domainGrid.appendChild(createGridItem(domain));
        });

        domainListBody.textContent = '';
        sortedDomains.forEach(domain => {
            domainListBody.appendChild(createListItem(domain));
        });
    }

    // Event Listeners
    searchButton.addEventListener('click', () => {
        const filteredDomains = filterDomains(allDomains);
        displayDomains(filteredDomains);
    });

    searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            const filteredDomains = filterDomains(allDomains);
            displayDomains(filteredDomains);
        }
    });

    priceFilter.addEventListener('change', () => {
        const filteredDomains = filterDomains(allDomains);
        displayDomains(filteredDomains);
    });

    tldFilter.addEventListener('change', () => {
        const filteredDomains = filterDomains(allDomains);
        displayDomains(filteredDomains);
    });

    sortSelect.addEventListener('change', () => {
        const filteredDomains = filterDomains(allDomains);
        displayDomains(filteredDomains);
    });
});